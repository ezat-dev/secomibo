<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="sparePart">

	<!-- sparePart 조회 -->
	<select id="getSparePartList" parameterType="sparePart"
		resultType="sparePart">
		SET LOCK_TIMEOUT 10000;

		WITH PARTS AS (
		SELECT
		MAX(SPAREPART.SPP_IDX) AS SPP_IDX,
		SUM(SPAREHISTORY.SPH_INPUT) AS SPH_INPUT,
		SUM(SPAREHISTORY.SPH_SURIOUT) AS SPH_SURIOUT,
		SUM(SPAREHISTORY.SPH_JASANOUT) AS SPH_JASANOUT,
		SPAREPART.SPP_PURCHASE,
		SPAREPART.SPP_NO,
		SPAREPART.SPP_NAME,
		SPAREPART.SPP_GYU,
		SPAREPART.SPP_YONG,
		SPAREPART.SPP_PROPER,
		SPAREPART.SPP_IMAGE,
		SPAREPART.SPP_BIGO,
		SPAREPART.FILE_NAME 
		FROM SPAREHISTORY WITH(NOLOCK)
		RIGHT OUTER JOIN SPAREPART WITH(NOLOCK) ON SPAREHISTORY.SPP_IDX =
		SPAREPART.SPP_IDX
		WHERE SPAREPART.SPP_IDX > 0
		GROUP BY
		SPAREPART.SPP_PURCHASE,
		SPAREPART.SPP_NO,
		SPAREPART.SPP_NAME,
		SPAREPART.SPP_GYU,
		SPAREPART.SPP_YONG,
		SPAREPART.SPP_PROPER,
		SPAREPART.SPP_IMAGE,
		SPAREPART.SPP_BIGO,
		SPAREPART.FILE_NAME
		)

		SELECT
		*,
		SPH_INPUT - SPH_SURIOUT - SPH_JASANOUT AS JAIGO
		FROM PARTS WITH(NOLOCK)
		ORDER BY SPP_NO ASC 

	</select>
	
	
	<!-- spareSub 조회 -->
	<select id="getSpareSubList" parameterType="sparePart"
		resultType="sparePart">
	  SET LOCK_TIMEOUT 10000;
	  SELECT SPAREPART.SPP_PURCHASE SPP_PURCHASE_HIS
			, SPAREPART.SPP_NO SPP_NO_HIS
			, SPAREPART.SPP_NAME SPP_NAME_HIS
			, SPAREPART.SPP_GYU SPP_GYU_HIS
			, SPAREPART.SPP_YONG SPP_YONG_HIS
			, SPAREHISTORY.SPH_IDX, SPH_TIME, SPH_INPUT, SPH_SURIOUT, SPH_JASANOUT, SPH_BIGO, SPH_USER
        FROM SPAREHISTORY WITH(NOLOCK)
          INNER JOIN SPAREPART WITH(NOLOCK) 
         ON SPAREPART.SPP_IDX = SPAREHISTORY.SPP_IDX
		WHERE 1=1
		<if test="spp_idx != 0">
			AND SPAREHISTORY.SPP_IDX = #{spp_idx}
		</if>
	</select>
	
	
	
	<insert id="sparePartInsertSave" parameterType="sparePart">
    	INSERT INTO SPAREPART
           (
           SPP_PURCHASE
           ,SPP_NO
           ,SPP_NAME
           ,SPP_GYU
           ,SPP_YONG
           ,SPP_PROPER
           ,SPP_IMAGE
           ,SPP_BIGO
           ,FILE_NAME
           )
     VALUES
           (
            #{spp_purchase}
           ,#{spp_no}
           ,#{spp_name}
           ,#{spp_gyu}
           ,#{spp_yong}
           ,#{spp_proper}
           ,#{spp_image}
           ,#{spp_bigo}
           ,#{file_name}
           )
	</insert>
	
	
	<update id="sparePartUpdateSave" parameterType="sparePart">
		SET LOCK_TIMEOUT 10000;
		UPDATE [dbo].[SPAREPART]
		SET [SPP_PURCHASE]	= #{spp_purchase}	
			,[SPP_NO]		= #{spp_no}			
			,[SPP_NAME]		= #{spp_name}		
			,[SPP_GYU]		= #{spp_gyu}		
			,[SPP_YONG]		= #{spp_yong}		
			,[SPP_PROPER]	= #{spp_proper}		
			,[SPP_IMAGE]	= #{spp_image}
			,[SPP_BIGO]		= #{spp_bigo}	
		<if test="file_name != null and file_name != ''">
            ,[FILE_NAME] = #{file_name}
        </if>	
	    WHERE SPP_IDX = #{spp_idx}
  	</update>
	
	<select id="sparePartDetail" parameterType="sparePart" resultType="sparePart">
		SET LOCK_TIMEOUT 10000;

	SELECT 
		SP.SPP_IDX                 AS spp_idx,
		SP.SPP_PURCHASE            AS spp_purchase,
		SP.SPP_NO                  AS spp_no,
		SP.SPP_NAME                AS spp_name,
		SP.SPP_GYU                 AS spp_gyu,
		SP.SPP_YONG                AS spp_yong,
		SP.SPP_PROPER              AS spp_proper,
		SP.SPP_IMAGE               AS spp_image,
		SP.SPP_BIGO                AS spp_bigo,
		SP.FILE_NAME               AS file_name,

		ISNULL(SUM(SH.SPH_INPUT), 0)       AS sph_input,
		ISNULL(SUM(SH.SPH_SURIOUT), 0)     AS sph_suriout,
		ISNULL(SUM(SH.SPH_JASANOUT), 0)    AS sph_jasanout,
		ISNULL(SUM(SH.SPH_INPUT), 0) - ISNULL(SUM(SH.SPH_SURIOUT), 0) - ISNULL(SUM(SH.SPH_JASANOUT), 0) AS spp_jaigo

	FROM SPAREPART SP WITH(NOLOCK)
	LEFT JOIN SPAREHISTORY SH WITH(NOLOCK) ON SP.SPP_IDX = SH.SPP_IDX
	WHERE SP.SPP_IDX = #{spp_idx}
	GROUP BY 
		SP.SPP_IDX, SP.SPP_PURCHASE, SP.SPP_NO, SP.SPP_NAME,
		SP.SPP_GYU, SP.SPP_YONG, SP.SPP_PROPER, SP.SPP_IMAGE, SP.SPP_BIGO,
		SP.FILE_NAME
	
	</select>
	
	
	<delete id="deleteSparePartGrid" parameterType="int">
		SET LOCK_TIMEOUT 10000;
	    DELETE FROM SPAREPART
	    WHERE SPP_IDX = #{spp_idx}
  </delete>


</mapper>